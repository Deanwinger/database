## 第五章  查询优化

### 5.1 使用索引

#### 5.1.1 索引的优点

- MySQL使用索引的方式有以下几种：

~~~
P201 的索引图很重要
    1. 加快where子句匹配的行进行搜索的速度， 或者加快与另一个表的行的匹配；
    2. 对于使用min（）或max（）函数，效率很高；
    3. 对于 order by 和 GROUP BY子句， 索引很高效；
~~~

#### 5.1.2 索引的代价

- 加快检索， 但是降低了索引列的插入， 删除和更新值的速度， 对于写操作较多的表来说， 在索引更新方面的开销会非常大；

- 索引占据更大的空间；
    a. MYISAM 表，对于大量的索引， 有可能导致索引文件比数据文件更快的到达其limit；
    b. Innodb系统表空间里的所有InnoDB表， 都共享同一个存储空间池（数据和索引集中存储在同一个文件）， 添加索引会使表空间里用于存储的空间减少的更快， 加速到达文件的limit；

#### `5.1.3 挑选索引`

- 为用于搜索， 排序或分组的列创建索引， 也就是说，最佳索引列是那些出现在where 子句， 连接子句， 或者是出现在order by或 GROUP BY子句中的列；

- 认真考虑数据列的基数，列的基数是指它所容纳的所有非重复值的个数， 通常来说，列的基数越高（包含的唯一值多， 重复值少）索引的效果越好；

- 索引值短小， 对于InnoDB更有好处，主键值会在每一个 二级索引（把主键值和二级索引值存储在一起）中重复出现，因此，如果主键值越长，则会导致每一个二级索引越大；

- 索引字符串的前缀

- 利用最左前缀， 当创建包含n个列的复合索引时，实际上会创建n个专供MySQL使用的索引，复合索引修当于多个索引， 因为索引中最左边的任意数据列集合都可以用于匹配

- 不要建立过多的索引： 1。每增加一个索引, 需要额外的磁盘空间，2.更新操作, 需相应的更新索引（P205）,3索引太多时，将无法使用最好的索引（增加查询优化的工作）

- 让参与比较的索引类型保持匹配 P205 值的一看

- 利用慢查询日志找出那些性能低劣的查询；


### 5.2 mysql查询优化

#### 5.2.1 查询优化程序的工作原理

- 查询优化的主要目标：尽可能的使用索引，并且使用最严格的索引来消除对行数量增加的顾虑

- 指导意见，有助于优化程序对索引的充分利用

~~~
    (1).分析表,将生成关于键值分布情况的统计数据；
    (2).使用explain验证优化程序的操作；
    (3).在必要时给予优化程序提示或者改写他
    (4).比较拥有相同数据类型的列
    (5).让索引在表达式中单独出现(P208值得一看)
    (6).不要在LIKE模式的开始位置使用通配符
    (7).利用优化程序的长处;
    (8).测试查询的各种替代形式，并多次运行他们
    (9).避免过多使用自动类型转换
~~~

#### 5.2.3 使用explain检查优化程序的操作

- 本节展示explain语句的两种用途

~~~
    1. explain 语句可以让我们了解到：以何种方式编写表达式会更优：
        explain 列值含义：
        （1）type：表明会如何从表读取各个值
                a. all：全表扫描，不用索引
                b. ref:可以通过引用值来完成索引查找
            possible_key: 可能使用的索引列
            key: 实际使用的索引列
            rows：此次查询需要检查的行数
            Extra:
                a. using where表明，where 子句里的信息，将被用于标示出符合条件的行；
                b. using index;
    2. 验证增加索引是否能有助于优化程序更有效的执行某条语句：
~~~

- 研究给表增加索引、对优化程序的影响



### 5.6 调度，锁定和并发

- MySQL的调度策略总结如下：

~~~
    - 写入的优先级比读取高
    - 表的写入操作一次只能进行一次，多个写入请求按到达的先后顺序依次处理
    - 可以同时处理多个对同一个表的的读取操作
    - InnoDB使用行级锁定操作，在很多情况下，如只读的操作完成之时，InnoDB根本不使用锁定操作；
    - 并发写入时，需要进行互斥锁定，更新操作比较多时，InnoDB性能较好；
    - 使用表锁定时， 不会出现死锁问题，InnoDB 的行级锁有可能出现，出现死锁时， 需要服务器中止其中一个事务才能解决此问题；
~~~







